name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-keyvault-demo
  CONTAINER_APP_NAME: ca-keyvault-demo-1769000752
  CONTAINER_APP_ENV: cae-keyvault-demo
  KEYVAULT_URL: https://kv-demo-1769000021.vault.azure.net/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Build and push Docker image
      run: |
        # Use Azure Container Registry (ACR) or Docker Hub
        # Option 1: Build and deploy directly to Container Apps
        az containerapp up \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --environment ${{ env.CONTAINER_APP_ENV }} \
          --source . \
          --ingress external \
          --target-port 8000 \
          --env-vars "KEYVAULT_URL=${{ env.KEYVAULT_URL }}" "API_TOKEN=secretref:api-token"

    - name: Get Container App URL
      id: get-url
      run: |
        URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)
        echo "CONTAINER_APP_URL=https://${URL}" >> $GITHUB_OUTPUT
        echo "Container App URL: https://${URL}"

    - name: Health check
      run: |
        sleep 30
        curl -f ${{ steps.get-url.outputs.CONTAINER_APP_URL }}/health || exit 1

    - name: Deployment summary
      run: |
        echo "### Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Container App:** ${{ env.CONTAINER_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** ${{ steps.get-url.outputs.CONTAINER_APP_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "**KeyVault:** ${{ env.KEYVAULT_URL }}" >> $GITHUB_STEP_SUMMARY
